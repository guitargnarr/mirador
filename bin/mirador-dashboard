#!/bin/bash
# Mirador Terminal Metrics Dashboard
# Renders key metrics from ~/.mirador/metrics.db

DB="${HOME}/.mirador/metrics.db"
RECENT_LIMIT=10
SECTION=""

usage() {
    echo "Usage: mirador-dashboard [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --recent N    Show last N executions (default: 10)"
    echo "  --models      Model usage breakdown only"
    echo "  --chains      Chain type breakdown only"
    echo "  -h, --help    Show this help"
}

while [[ $# -gt 0 ]]; do
    case "$1" in
        --recent)
            SECTION="recent"
            RECENT_LIMIT="${2:-10}"
            shift 2
            ;;
        --models)
            SECTION="models"
            shift
            ;;
        --chains)
            SECTION="chains"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

if [ ! -f "$DB" ]; then
    echo "Error: metrics database not found at $DB"
    exit 1
fi

row_count=$(sqlite3 "$DB" "SELECT COUNT(*) FROM executions;")
if [ "$row_count" -eq 0 ]; then
    echo "No executions recorded yet."
    exit 0
fi

# Build list of installed ollama models for filtering
INSTALLED_MODELS=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | sed 's/:latest$//')

# Load installed models into a temp SQLite table for SQL-level filtering
FILTER_SETUP="CREATE TEMP TABLE IF NOT EXISTS installed_models(name TEXT PRIMARY KEY);"
while IFS= read -r m; do
    [ -n "$m" ] && FILTER_SETUP="${FILTER_SETUP}INSERT OR IGNORE INTO installed_models VALUES('$m');"
done <<< "$INSTALLED_MODELS"

# Common CTE: normalize models_used, strip :latest, filter to installed only
# Usage: prepend NORMALIZE_CTE to queries that need per-execution model filtering
NORMALIZE_CTE="
WITH split_raw AS (
    SELECT
        e.id AS exec_id,
        REPLACE(TRIM(j.value, '\"\" '), ':latest', '') AS model,
        e.duration_seconds,
        e.task_type,
        e.start_time,
        e.prompt,
        e.success,
        e.tokens_output
    FROM executions e,
         json_each(
             CASE
                 WHEN e.models_used LIKE '[%' THEN e.models_used
                 ELSE '[\"' || REPLACE(e.models_used, ',', '\",\"') || '\"]'
             END
         ) AS j
),
split_models AS (
    SELECT * FROM split_raw WHERE model != '' AND model IN (SELECT name FROM installed_models)
),
valid_executions AS (
    SELECT DISTINCT exec_id FROM split_models
)"

divider() {
    printf '%*s\n' 70 '' | tr ' ' '-'
}

header() {
    echo ""
    divider
    echo "  $1"
    divider
}

# --- OVERVIEW ---
show_overview() {
    header "OVERVIEW"
    sqlite3 -separator '|' "$DB" "
        SELECT
            COUNT(*) AS total,
            ROUND(100.0 * SUM(success) / COUNT(*), 1) AS success_pct,
            ROUND(SUM(duration_seconds), 1) AS total_sec,
            MIN(date(start_time)) AS first_run,
            MAX(date(start_time)) AS last_run
        FROM executions;
    " | while IFS='|' read -r total pct secs first last; do
        printf "  %-24s %s\n" "Total executions:" "$total"
        printf "  %-24s %s%%\n" "Success rate:" "$pct"
        printf "  %-24s %ss\n" "Total time:" "$secs"
        printf "  %-24s %s to %s\n" "Date range:" "$first" "$last"
    done
    local model_count
    model_count=$(echo "$INSTALLED_MODELS" | grep -c .)
    printf "  %-24s %s\n" "Installed models:" "$model_count"
}

# --- BY CHAIN TYPE ---
show_chains() {
    header "BY CHAIN TYPE"
    printf "  %-20s %6s %10s %8s %10s\n" "TYPE" "COUNT" "AVG(sec)" "TOK/s" "SUCCESS%"
    printf "  %-20s %6s %10s %8s %10s\n" "----" "-----" "--------" "-----" "--------"
    sqlite3 -separator '|' "$DB" "
        SELECT
            COALESCE(task_type, 'unknown'),
            COUNT(*),
            ROUND(AVG(duration_seconds), 1),
            CASE WHEN AVG(duration_seconds) > 0
                THEN ROUND(AVG(tokens_output * 1.0 / duration_seconds), 1)
                ELSE 0 END,
            ROUND(100.0 * SUM(success) / COUNT(*), 1)
        FROM executions
        GROUP BY task_type
        ORDER BY COUNT(*) DESC;
    " | while IFS='|' read -r ttype cnt avg tps pct; do
        printf "  %-20s %6s %10s %8s %9s%%\n" "$ttype" "$cnt" "$avg" "$tps" "$pct"
    done
}

# --- BY MODEL ---
show_models() {
    header "BY MODEL"
    printf "  %-40s %6s %10s %8s\n" "MODEL" "COUNT" "AVG(sec)" "TOK/s"
    printf "  %-40s %6s %10s %8s\n" "-----" "-----" "--------" "-----"
    sqlite3 -separator '|' "$DB" "
        $FILTER_SETUP
        $NORMALIZE_CTE
        SELECT
            model,
            COUNT(*),
            ROUND(AVG(duration_seconds), 1),
            CASE WHEN AVG(duration_seconds) > 0
                THEN ROUND(AVG(tokens_output * 1.0 / duration_seconds), 1)
                ELSE 0 END
        FROM split_models
        GROUP BY model
        ORDER BY COUNT(*) DESC;
    " | while IFS='|' read -r model cnt avg tps; do
        printf "  %-40s %6s %10s %8s\n" "$model" "$cnt" "$avg" "$tps"
    done
}

# --- RECENT ACTIVITY ---
show_recent() {
    header "RECENT ACTIVITY (last $RECENT_LIMIT)"
    printf "  %-12s %-22s %8s %8s  %s\n" "DATE" "TYPE" "SEC" "STATUS" "PROMPT"
    printf "  %-12s %-22s %8s %8s  %s\n" "----" "----" "---" "------" "-----"
    sqlite3 -separator '|' "$DB" "
        SELECT
            date(start_time),
            COALESCE(task_type, 'unknown'),
            ROUND(duration_seconds, 1),
            CASE WHEN success THEN 'OK' ELSE 'FAIL' END,
            SUBSTR(prompt, 1, 40)
        FROM executions
        ORDER BY start_time DESC
        LIMIT $RECENT_LIMIT;
    " | while IFS='|' read -r dt ttype dur status prompt; do
        printf "  %-12s %-22s %8s %8s  %s\n" "$dt" "$ttype" "$dur" "$status" "$prompt"
    done
}

# --- PERFORMANCE ---
show_performance() {
    header "PERFORMANCE"
    echo ""
    echo "  Fastest:"
    sqlite3 -separator '|' "$DB" "
        $FILTER_SETUP
        $NORMALIZE_CTE
        SELECT COALESCE(e.task_type,'unknown'), ROUND(e.duration_seconds,1), SUBSTR(e.prompt,1,50)
        FROM executions e
        WHERE e.id IN (SELECT exec_id FROM valid_executions)
        ORDER BY e.duration_seconds ASC LIMIT 3;
    " | while IFS='|' read -r ttype dur prompt; do
        printf "    %6ss  %-18s  %s\n" "$dur" "$ttype" "$prompt"
    done

    echo ""
    echo "  Slowest:"
    sqlite3 -separator '|' "$DB" "
        $FILTER_SETUP
        $NORMALIZE_CTE
        SELECT COALESCE(e.task_type,'unknown'), ROUND(e.duration_seconds,1), SUBSTR(e.prompt,1,50)
        FROM executions e
        WHERE e.id IN (SELECT exec_id FROM valid_executions)
        ORDER BY e.duration_seconds DESC LIMIT 3;
    " | while IFS='|' read -r ttype dur prompt; do
        printf "    %6ss  %-18s  %s\n" "$dur" "$ttype" "$prompt"
    done

    echo ""
    echo "  Avg tokens output by chain type:"
    printf "    %-20s %12s\n" "TYPE" "AVG_TOKENS"
    printf "    %-20s %12s\n" "----" "----------"
    sqlite3 -separator '|' "$DB" "
        $FILTER_SETUP
        $NORMALIZE_CTE
        SELECT COALESCE(e.task_type,'unknown'), ROUND(AVG(e.tokens_output),0)
        FROM executions e
        WHERE e.id IN (SELECT exec_id FROM valid_executions)
        GROUP BY e.task_type ORDER BY AVG(e.tokens_output) DESC;
    " | while IFS='|' read -r ttype avg; do
        printf "    %-20s %12s\n" "$ttype" "$avg"
    done
}

# --- RENDER ---
echo ""
echo "  MIRADOR METRICS DASHBOARD"
echo "  $(date '+%Y-%m-%d %H:%M')"

case "$SECTION" in
    recent)  show_recent ;;
    models)  show_models ;;
    chains)  show_chains ;;
    *)
        show_overview
        show_chains
        show_models
        show_recent
        show_performance
        ;;
esac

echo ""
