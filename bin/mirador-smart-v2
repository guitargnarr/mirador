#!/bin/bash
# Mirador Smart Router V2 - Consolidated Models Edition
# Intelligently routes queries to optimal model chains

# Configuration
MIRADOR_HOME="${HOME}/Projects/mirador"
CONFIG_FILE="${MIRADOR_HOME}/config/model_routing_v2.yaml"

# Source metrics logger
source "${MIRADOR_HOME}/bin/mirador_metrics.sh"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# Function to analyze query intent
analyze_query() {
    local query="$1"
    local query_lower=$(echo "$query" | tr '[:upper:]' '[:lower:]')

    # Quick response patterns
    if [[ "$query_lower" =~ (quick|brief|summary|tldr|short|what.*now|immediate) ]]; then
        echo "quick"
        return
    fi

    # Financial patterns
    if [[ "$query_lower" =~ (money|budget|finance|salary|investment|savings|afford|cost|spend) ]]; then
        echo "financial"
        return
    fi

    # Health & wellness patterns
    if [[ "$query_lower" =~ (health|fitness|wellness|stress|sleep|energy|tired|exercise|nutrition) ]]; then
        echo "health"
        return
    fi

    # Louisville/location patterns
    if [[ "$query_lower" =~ (louisville|kentucky|local|jcps|school|neighborhood|downtown) ]]; then
        echo "location"
        return
    fi

    # Music patterns
    if [[ "$query_lower" =~ (music|guitar|practice|performance|song|play|band|chord) ]]; then
        echo "music"
        return
    fi

    # Career/corporate patterns
    if [[ "$query_lower" =~ (career|job|promotion|[company]|corporate|work|meeting|boss|ai.*leader) ]]; then
        echo "career"
        return
    fi

    # Creative patterns
    if [[ "$query_lower" =~ (creative|innovate|idea|breakthrough|design|imagine|invent) ]]; then
        echo "creative"
        return
    fi

    # Family/relationship patterns
    if [[ "$query_lower" =~ (family|kids|teens|relationship|parenting|daughter|son|children) ]]; then
        echo "family"
        return
    fi

    # Default to strategic
    echo "strategic"
}

# Function to get model chain for intent
get_model_chain() {
    local intent="$1"

    case "$intent" in
        "quick")
            echo "quick-advisor-phi"
            ;;
        "financial")
            echo "universal_context_provider financial_planning_expert_v6 decision_simplifier_v2"
            ;;
        "health")
            echo "universal_context_provider health_wellness_optimizer decision_simplifier_v2"
            ;;
        "location")
            echo "louisville-job-market decision_simplifier_v2"
            ;;
        "music")
            echo "universal_context_provider master_guitar_instructor cross_model_synthesizer"
            ;;
        "career")
            echo "universal_context_provider matthew-career-coach cot-career-strategist"
            ;;
        "creative")
            echo "universal_context_provider content_strategist_pro cross_model_synthesizer"
            ;;
        "family")
            echo "universal_context_provider decision_enhancer decision_simplifier_v2"
            ;;
        "strategic"|*)
            echo "universal_context_provider cross_model_synthesizer gemma2:9b decision_simplifier_v2"
            ;;
    esac
}

# Main execution
if [ $# -eq 0 ]; then
    echo "Usage: $0 \"Your query here\""
    echo ""
    echo "Smart routing will automatically select the best model chain based on your query."
    echo ""
    echo "Available intents:"
    echo "  - quick: Fast responses for immediate needs"
    echo "  - financial: Money, budgeting, investment advice"
    echo "  - health: Wellness, fitness, lifestyle optimization"
    echo "  - location: Louisville-specific knowledge"
    echo "  - music: Guitar, practice, performance guidance"
    echo "  - career: Professional development, corporate strategy"
    echo "  - creative: Innovation, breakthrough thinking"
    echo "  - family: Parenting, relationships, family dynamics"
    echo "  - strategic: Deep analysis and planning (default)"
    exit 1
fi

QUERY="$1"

# Analyze query
echo -e "${YELLOW}Analyzing query intent...${NC}"
INTENT=$(analyze_query "$QUERY")
echo -e "${GREEN}Intent detected: ${INTENT}${NC}"

# Get model chain
MODELS=$(get_model_chain "$INTENT")
echo -e "${BLUE}Selected models: ${MODELS}${NC}"
echo ""

# Start metrics
SESSION_ID=$(metrics_session_id)
metrics_start "$SESSION_ID" "$QUERY" "smart-v2:${INTENT}"

# Execute with selected models
if [ "$INTENT" = "quick" ]; then
    # For quick queries, use simple Ollama call
    echo -e "${GREEN}Quick Response:${NC}"
    MODEL_START=$(date +%s)
    RESPONSE=$(echo "$QUERY" | ollama run quick-advisor-phi 2>/dev/null)
    MODEL_END=$(date +%s)
    MODEL_ELAPSED=$(( MODEL_END - MODEL_START ))
    echo "$RESPONSE"
    metrics_log_model "quick-advisor-phi" "${#RESPONSE}" "$MODEL_ELAPSED" "1"
else
    # For complex queries, execute chain manually
    echo -e "${YELLOW}Processing through model chain...${NC}"

    # Initialize context
    CONTEXT=""

    # Process through each model in the chain
    for MODEL in $MODELS; do
        echo -e "${BLUE}-> Running $MODEL${NC}"
        MODEL_START=$(date +%s)

        if [ -z "$CONTEXT" ]; then
            # First model gets just the query
            RESPONSE=$(echo "$QUERY" | ollama run "$MODEL" 2>/dev/null)
        else
            # Subsequent models get query + accumulated context
            PROMPT="$QUERY

Previous analysis:
$CONTEXT"
            RESPONSE=$(echo "$PROMPT" | ollama run "$MODEL" 2>/dev/null)
        fi

        MODEL_END=$(date +%s)
        MODEL_ELAPSED=$(( MODEL_END - MODEL_START ))

        # Log model metrics
        if [ -n "$RESPONSE" ]; then
            metrics_log_model "$MODEL" "${#RESPONSE}" "$MODEL_ELAPSED" "1"
        else
            metrics_log_model "$MODEL" "0" "$MODEL_ELAPSED" "0"
        fi

        # Show response
        echo "$RESPONSE"
        echo ""

        # Accumulate context
        CONTEXT="$CONTEXT

$RESPONSE"
    done
fi

# Finish metrics
if [ "$_METRICS_ERROR_COUNT" -eq 0 ]; then
    metrics_finish 1
else
    metrics_finish 0
fi

echo -e "${GREEN}[Session: ${SESSION_ID}]${NC}"
