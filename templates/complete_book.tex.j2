\documentclass[10pt,openany]{book}
\usepackage[margin=0.75in]{geometry}
\usepackage{fancyvrb}
\usepackage[T1]{fontenc}
\usepackage{hyperref}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{titlesec}
\usepackage{eso-pic}

% ── Color Palette (warm/amber — guitar resonance) ────────────────
\definecolor{coverblack}{HTML}{0d0d0d}
\definecolor{deepchar}{HTML}{1a1816}
\definecolor{warmchar}{HTML}{2a2420}
\definecolor{amber}{HTML}{c8842e}
\definecolor{copper}{HTML}{b5651d}
\definecolor{paleamber}{HTML}{e8c47c}
\definecolor{warmwhite}{HTML}{f5f0e8}
\definecolor{dimgold}{HTML}{8a7040}
\definecolor{softgray}{HTML}{e8e8e8}
\definecolor{medgray}{HTML}{888888}
% ── Per-key chapter color palettes ───────────────────────────────
<% for cd in color_defs %>
\definecolor{<< cd.name >>bg}{HTML}{<< cd.bg >>}
\definecolor{<< cd.name >>acc}{HTML}{<< cd.accent >>}
<% endfor %>

\hypersetup{colorlinks=true,linkcolor=copper,urlcolor=copper}
\pagestyle{plain}
\setlength{\parindent}{0pt}
\setlength{\parskip}{4pt}
\setcounter{tocdepth}{1}

\begin{document}

% ══════════════════════════════════════════════════════════════════
% COVER PAGE
% ══════════════════════════════════════════════════════════════════
\thispagestyle{empty}
\begin{tikzpicture}[remember picture, overlay]

  % ── Deep black background ──────────────────────────────────────
  \fill[coverblack] (current page.south west) rectangle (current page.north east);

  % ── Layer 1: Large translucent organic shapes (depth) ──────────
  % Upper-right warm blob
  \fill[warmchar, opacity=0.45]
    ([xshift=0.55\paperwidth, yshift=0.78\paperheight]current page.south west)
    circle [x radius=3.8in, y radius=4.2in];
  % Center-left darker blob
  \fill[deepchar, opacity=0.5]
    ([xshift=0.25\paperwidth, yshift=0.55\paperheight]current page.south west)
    circle [x radius=3.2in, y radius=3.6in];
  % Lower-right subtle blob
  \fill[warmchar, opacity=0.3]
    ([xshift=0.72\paperwidth, yshift=0.22\paperheight]current page.south west)
    circle [x radius=2.8in, y radius=3.0in];
  % Upper-left edge blob
  \fill[deepchar, opacity=0.35]
    ([xshift=0.08\paperwidth, yshift=0.85\paperheight]current page.south west)
    circle [x radius=2.5in, y radius=2.8in];

  % ── Layer 2: Concentric resonance rings (sound wave motif) ─────
  \foreach \r/\o in {1.8/0.06, 2.4/0.05, 3.0/0.04, 3.6/0.035, 4.2/0.03, 4.8/0.025, 5.4/0.02} {
    \draw[amber, opacity=\o, line width=0.4pt]
      ([xshift=0.42\paperwidth, yshift=0.48\paperheight]current page.south west)
      circle [radius=\r in];
  }

  % ── Layer 3: Subtle geometric arcs (editorial refinement) ──────
  \draw[dimgold, opacity=0.08, line width=0.6pt]
    ([xshift=0.15\paperwidth, yshift=0.70\paperheight]current page.south west)
    arc [start angle=160, end angle=20, x radius=3.5in, y radius=2in];
  \draw[dimgold, opacity=0.06, line width=0.4pt]
    ([xshift=0.60\paperwidth, yshift=0.25\paperheight]current page.south west)
    arc [start angle=200, end angle=340, x radius=4in, y radius=2.5in];
  \draw[copper, opacity=0.05, line width=0.5pt]
    ([xshift=0.80\paperwidth, yshift=0.65\paperheight]current page.south west)
    arc [start angle=120, end angle=240, x radius=2in, y radius=3in];

  % ── Layer 4: Fine scattered diamond accents ────────────────────
  \foreach \x/\y/\o in {0.18/0.35/0.12, 0.78/0.72/0.10, 0.85/0.28/0.08, 0.12/0.78/0.09, 0.65/0.15/0.07, 0.35/0.88/0.06} {
    \node[rotate=45, opacity=\o] at ([xshift=\x\paperwidth, yshift=\y\paperheight]current page.south west)
      {\color{amber}\tiny$\diamond$};
  }

  % ── Layer 5: Horizontal rule with warm glow ────────────────────
  \shade[left color=coverblack, right color=amber, middle color=amber, opacity=0.6]
    ([xshift=1.8in, yshift=0.635\paperheight]current page.south west)
    rectangle ([xshift=-1.8in, yshift=0.638\paperheight]current page.south east);

  % ── Top border accent ──────────────────────────────────────────
  \shade[left color=coverblack, right color=copper, middle color=amber]
    ([yshift=-3pt]current page.north west) rectangle ([yshift=-5pt]current page.north east);

  % ── Bottom border accent ───────────────────────────────────────
  \shade[left color=copper, right color=coverblack, middle color=amber]
    ([yshift=3pt]current page.south west) rectangle ([yshift=5pt]current page.south east);

  % ── Typography ─────────────────────────────────────────────────

  % Category label (spaced small caps)
  \node[anchor=center, text=amber, font=\footnotesize\scshape, inner sep=0pt]
    at ([yshift=0.80\paperheight]current page.south)
    {C\kern0.12em O\kern0.12em M\kern0.12em P\kern0.12em L\kern0.12em E\kern0.12em T\kern0.12em E\kern0.35em R\kern0.12em E\kern0.12em F\kern0.12em E\kern0.12em R\kern0.12em E\kern0.12em N\kern0.12em C\kern0.12em E};

  % Title
  \node[anchor=center, text=warmwhite, font=\fontsize{42}{50}\bfseries\selectfont, text width=5.5in, align=center]
    at ([yshift=0.72\paperheight]current page.south) {<< title >>};

  % Accent rule under title
  \draw[amber, line width=1.2pt]
    ([xshift=-1.2in, yshift=0.655\paperheight]current page.south) --
    ([xshift=1.2in, yshift=0.655\paperheight]current page.south);

  % Subtitle
  \node[anchor=center, text=paleamber, font=\large, inner sep=0pt]
    at ([yshift=0.62\paperheight]current page.south)
    {Every Key \quad\textperiodcentered\quad Every Position \quad\textperiodcentered\quad Every Exercise};

  % Description block
  \node[anchor=center, text=warmwhite, font=\small, text width=5in, align=center, opacity=0.85]
    at ([yshift=0.38\paperheight]current page.south) {<< scale_description >>};

  % Stats line
  \node[anchor=center, text=amber, font=\normalsize\bfseries]
    at ([yshift=0.28\paperheight]current page.south)
    {<< num_keys >> Keys \quad\textbullet\quad << num_positions >> Positions \quad\textbullet\quad << total_exercises >> Exercises \quad\textbullet\quad << total_tabs >> Tab Blocks};

  % Footer
  \node[anchor=center, text=dimgold, font=\footnotesize, opacity=0.7]
    at ([yshift=0.10\paperheight]current page.south)
    {All tablature verified by mathematical fretboard computation};

  \node[anchor=center, text=dimgold, font=\scriptsize, opacity=0.5]
    at ([yshift=0.07\paperheight]current page.south)
    {Generated by mirador-tab-generator};

\end{tikzpicture}
\newpage

% ══════════════════════════════════════════════════════════════════
% TABLE OF CONTENTS
% ══════════════════════════════════════════════════════════════════
\tableofcontents
\newpage

% ══════════════════════════════════════════════════════════════════
% PARTS AND CHAPTERS
% ══════════════════════════════════════════════════════════════════
<% for part in parts %>
<% if part.title %>
% ── Part Divider Page ─────────────────────────────────────────────
\thispagestyle{empty}
% Define part-specific colors
\definecolor{partbg}{HTML}{<< part.bg_hex >>}
\definecolor{partblob}{HTML}{<< part.blob_hex >>}
\definecolor{partacc}{HTML}{<< part.acc_hex >>}
\definecolor{partlit}{HTML}{<< part.lit_hex >>}
\begin{tikzpicture}[remember picture, overlay]

  % ── Deep background ────────────────────────────────────────────
  \fill[partbg] (current page.south west) rectangle (current page.north east);

  % ── Layer 1: Large translucent organic shapes ──────────────────
  \fill[partblob, opacity=0.45]
    ([xshift=0.55\paperwidth, yshift=0.78\paperheight]current page.south west)
    circle [x radius=3.8in, y radius=4.2in];
  \fill[partblob, opacity=0.5]
    ([xshift=0.25\paperwidth, yshift=0.55\paperheight]current page.south west)
    circle [x radius=3.2in, y radius=3.6in];
  \fill[partblob, opacity=0.3]
    ([xshift=0.72\paperwidth, yshift=0.22\paperheight]current page.south west)
    circle [x radius=2.8in, y radius=3.0in];
  \fill[partblob, opacity=0.35]
    ([xshift=0.08\paperwidth, yshift=0.85\paperheight]current page.south west)
    circle [x radius=2.5in, y radius=2.8in];

  % ── Layer 2: Concentric resonance rings ────────────────────────
  \foreach \r/\o in {1.8/0.06, 2.4/0.05, 3.0/0.04, 3.6/0.035, 4.2/0.03, 4.8/0.025, 5.4/0.02} {
    \draw[partacc, opacity=\o, line width=0.4pt]
      ([xshift=0.42\paperwidth, yshift=0.48\paperheight]current page.south west)
      circle [radius=\r in];
  }

  % ── Layer 3: Geometric arcs ────────────────────────────────────
  \draw[partacc, opacity=0.08, line width=0.6pt]
    ([xshift=0.15\paperwidth, yshift=0.70\paperheight]current page.south west)
    arc [start angle=160, end angle=20, x radius=3.5in, y radius=2in];
  \draw[partacc, opacity=0.06, line width=0.4pt]
    ([xshift=0.60\paperwidth, yshift=0.25\paperheight]current page.south west)
    arc [start angle=200, end angle=340, x radius=4in, y radius=2.5in];
  \draw[partacc, opacity=0.05, line width=0.5pt]
    ([xshift=0.80\paperwidth, yshift=0.65\paperheight]current page.south west)
    arc [start angle=120, end angle=240, x radius=2in, y radius=3in];

  % ── Layer 4: Diamond accents ───────────────────────────────────
  \foreach \x/\y/\o in {0.15/0.30/0.10, 0.82/0.75/0.08, 0.88/0.22/0.07, 0.08/0.72/0.09} {
    \node[rotate=45, opacity=\o] at ([xshift=\x\paperwidth, yshift=\y\paperheight]current page.south west)
      {\color{partacc}\tiny$\diamond$};
  }

  % ── Layer 5: Horizontal rule with glow ──────────────────────────
  \shade[left color=partbg, right color=partacc, middle color=partacc, opacity=0.6]
    ([xshift=1.8in, yshift=0.595\paperheight]current page.south west)
    rectangle ([xshift=-1.8in, yshift=0.598\paperheight]current page.south east);

  % ── Top border accent ──────────────────────────────────────────
  \shade[left color=partbg, right color=partacc, middle color=partacc]
    ([yshift=-3pt]current page.north west) rectangle ([yshift=-5pt]current page.north east);

  % ── Bottom border accent ───────────────────────────────────────
  \shade[left color=partacc, right color=partbg, middle color=partacc]
    ([yshift=3pt]current page.south west) rectangle ([yshift=5pt]current page.south east);

  % ── Typography ─────────────────────────────────────────────────

  % Part label (spaced small caps)
  \node[anchor=center, text=partacc, font=\footnotesize\scshape]
    at ([yshift=0.78\paperheight]current page.south)
    {P\kern0.15em A\kern0.15em R\kern0.15em T};

  % Part title
  \node[anchor=center, text=warmwhite, font=\fontsize{34}{40}\bfseries\selectfont, text width=5.5in, align=center]
    at ([yshift=0.68\paperheight]current page.south) {<< part.title >>};

  % Accent rule under title
  \draw[partacc, line width=1.2pt]
    ([xshift=-1.2in, yshift=0.625\paperheight]current page.south) --
    ([xshift=1.2in, yshift=0.625\paperheight]current page.south);

  % Part description
  \node[anchor=center, text=warmwhite, font=\small, text width=5in, align=center, opacity=0.85]
    at ([yshift=0.44\paperheight]current page.south) {<< part.description >>};

  % Key list
  \node[anchor=center, text=partlit, font=\normalsize, text width=6in, align=center]
    at ([yshift=0.32\paperheight]current page.south) {<< part.key_list >>};

  % Footer
  \node[anchor=center, text=partacc, font=\scriptsize, opacity=0.4]
    at ([yshift=0.08\paperheight]current page.south)
    {mirador-tab-generator};

\end{tikzpicture}
\clearpage
\addcontentsline{toc}{part}{<< part.title >>}
<% endif %>

<% for chapter in part.chapters %>
\clearpage
\thispagestyle{plain}
\addcontentsline{toc}{chapter}{<< chapter.title >>}
\noindent\begin{tikzpicture}[remember picture, overlay]
  \fill[<< chapter.color >>bg] ([yshift=2pt]current page.north west) rectangle ([yshift=-60pt]current page.north east);
  \node[anchor=west, text=white, font=\Huge\bfseries] at ([yshift=-30pt, xshift=1in]current page.north west) {<< chapter.title >>};
  \shade[left color=<< chapter.color >>bg, right color=<< chapter.color >>acc, middle color=<< chapter.color >>acc]
    ([yshift=-62pt, xshift=0.75in]current page.north west) rectangle ([yshift=-63.5pt, xshift=-0.75in]current page.north east);
\end{tikzpicture}
\vspace{50pt}

\noindent{\color{medgray}\small << chapter.info >> }
\vspace{8pt}

\section*{Scale Positions}

<% for pos in chapter.positions %>
\subsection*{Position << pos.number >> \hfill {\normalfont\color{medgray}Frets << pos.fret_range >>}}
\begin{Verbatim}[fontsize=\small,xleftmargin=8pt]
<< pos.tab >>
\end{Verbatim}
{\footnotesize\color{medgray} << pos.notes >> }
\vspace{4pt}
<% endfor %>

\section*{Companion Chords}
{\small Play these chords over your << chapter.key_name >> exercises:}
\begin{Verbatim}[fontsize=\small,xleftmargin=8pt]
<< chapter.chords_tab >>
\end{Verbatim}
{\small Progression: \textbf{<< chapter.progression >>} }
\vspace{8pt}
{\color{<< chapter.color >>acc}\hrule}
\vspace{8pt}

\section*{Exercises}

<% for pos_group in chapter.exercise_groups %>
\subsection*{{\color{<< chapter.color >>acc}Position << pos_group.number >>} Exercises}

<% for ex in pos_group.exercises %>
\textbf{<< ex.name >>}
<% if ex.description %>
\par{\small\color{medgray}\itshape << ex.description >>}
<% endif %>
\begin{Verbatim}[fontsize=\small,xleftmargin=8pt]
<< ex.tab >>
\end{Verbatim}
\vspace{2pt}
<% endfor %>
<% endfor %>

<% endfor %>
<% endfor %>

\end{document}
